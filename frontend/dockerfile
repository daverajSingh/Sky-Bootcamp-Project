# Dev-friendly image that runs Vite and avoids cold npm install at runtime
FROM node:22-bookworm-slim

# Install minimal system packages if needed (none for Vite)
WORKDIR /app

# Install dependencies first for better layer caching (ignore cross-OS lock issues)
COPY package*.json ./
RUN set -eux; \
    # Remove lockfile to avoid cross-OS optional dependency issues (rollup native binary)
    rm -f package-lock.json; \
    npm install --silent; \
    # Ensure any native modules are correctly built for this platform
    npm rebuild --silent || true; \
    # As a guard, ensure the linux rollup native package is present
    npm ls @rollup/rollup-linux-x64-gnu >/dev/null 2>&1 || npm i -D @rollup/rollup-linux-x64-gnu --no-save --silent

# Copy source
COPY . .

ENV CHOKIDAR_USEPOLLING=true
EXPOSE 5173

# Bind to all interfaces explicitly
CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
