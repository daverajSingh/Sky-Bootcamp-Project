# Dev-friendly image that runs Vite and avoids cold npm install at runtime
FROM node:22-bookworm-slim

# Install minimal system packages if needed (none for Vite)
WORKDIR /app

# Install dependencies first for better layer caching
COPY package*.json ./
# If there is no package-lock.json, npm ci will fail; fall back to npm install
RUN set -eux; \
    if [ -f package-lock.json ]; then \
      npm ci --silent || (rm -rf node_modules package-lock.json && npm install --silent); \
    else \
      npm install --silent; \
    fi; \
    # Ensure any native modules are correctly built for this platform
    npm rebuild --silent || true

# Copy source
COPY . .

ENV CHOKIDAR_USEPOLLING=true
EXPOSE 5173

# Bind to all interfaces explicitly
CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
